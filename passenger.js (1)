import { db } from "./firebase.js";
import {
  ref, set, remove, onValue, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

let map, myMarker, requestId = null;

navigator.geolocation.getCurrentPosition(pos => {
  map = L.map("map").setView([pos.coords.latitude, pos.coords.longitude], 15);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  myMarker = L.circle([pos.coords.latitude, pos.coords.longitude], { radius: 30 }).addTo(map);
});

hailBtn.onclick = () => {
  if (requestId) return alert("Already requested");
  requestId = "req_" + Date.now();
  navigator.geolocation.getCurrentPosition(pos => {
    set(ref(db, "requests/" + requestId), {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      time: serverTimestamp()
    });
  });
};

cancelBtn.onclick = () => {
  if (requestId) {
    remove(ref(db, "requests/" + requestId));
    requestId = null;
  }
};

onValue(ref(db, "drivers"), snap => {
  snap.forEach(d => {
    const v = d.val();
    L.marker([v.lat, v.lng]).addTo(map)
      .bindPopup(`${v.taxiNumber} (${v.seats} seats)`);
  });
});

onValue(ref(db, "requests"), snap => {
  snap.forEach(r => {
    if (r.val().driver) {
      document.getElementById("acceptedSound").play();
    }
  });
});